<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="record.mapper.RecordMapper">
	<insert id="insertRecord" parameterType="rdto">
		insert into record(member_no, cardset_no, category, rightcnt, wrongcnt, method, recordday)
		values(#{member_no}, #{cardset_no}, #{category}, #{rightcnt}, #{wrongcnt}, #{method},now())
	</insert>
	
	<select id="getMaxNo" parameterType="rdto" resultType="Integer">
		select max(no)
		from record
		where member_no = #{member_no}
	</select>
	
	<insert id="insertDetailRecord" parameterType="ddto">
		insert into detailrecord
		values(#{record_no}, #{question_no}, #{question}, #{answer}, #{useranswer}, #{type}, #{result})
	</insert>
	
	<insert id="insertStudy" parameterType="Map">
		insert into study(member_no, cardset_no, studyday, category)
		values (#{member_no}, #{cardset_no}, now(), #{category})
	</insert>
	
	<select id="getList" parameterType="Map" resultType="rdto">
		select r.*
		from (
				select r.*,c.title, c.comment, m.name, 
						if(
					   		INSTR(profile,'google')>0,
					   		m.profile,
					   		if(
					   			INSTR(m.profile,'kakao')>0,
					   			m.profile,
					   			if(
					   				INSTR(m.profile,m.no)>0,
					   				concat('http://localhost:9000/profile/users/',m.profile),
					   				concat('http://localhost:9000/profile/default/',m.profile)
					   			)
					   		)
					   	) as profile
				from record r,cardset c, member m 
				where r.member_no = #{member_no} and r.cardset_no = c.no and c.member_no = m.no
				order by recordday desc) as r
		group by r.cardset_no, r.method
	</select>
	
	<select id="getLastList" parameterType="Map" resultType="rdto">
		select r.*
		from (
				select r.*,c.title, c.comment, m.name, 
						if(
					   		INSTR(profile,'google')>0,
					   		m.profile,
					   		if(
					   			INSTR(m.profile,'kakao')>0,
					   			m.profile,
					   			if(
					   				INSTR(m.profile,m.no)>0,
					   				concat('http://localhost:9000/profile/users/',m.profile),
					   				concat('http://localhost:9000/profile/default/',m.profile)
					   			)
					   		)
					   	) as profile
				from record r,cardset c, member m 
				where r.member_no = #{member_no} and r.cardset_no = c.no and c.member_no = m.no
				order by recordday desc) as r
		group by r.cardset_no
	</select>
	
	<select id="getChartList" parameterType="Map" resultType="rdto">
		select *
		from record
		where member_no = #{member_no} and cardset_no in (select cardset_no
												from record
												group by cardset_no)
		order by cardset_no asc, method desc, recordday asc
	</select>
	
	<select id="getDiagram" parameterType="Map" resultType="rdto">
		select r.*
		from (
				select r.*,c.title, c.comment, m.name, 
						if(
					   		INSTR(profile,'google')>0,
					   		m.profile,
					   		if(
					   			INSTR(m.profile,'kakao')>0,
					   			m.profile,
					   			if(
					   				INSTR(m.profile,m.no)>0,
					   				concat('http://localhost:9000/profile/users/',m.profile),
					   				concat('http://localhost:9000/profile/default/',m.profile)
					   			)
					   		)
					   	) as profile
				from record r,cardset c, member m 
				where r.member_no = #{member_no} and r.cardset_no = #{cardset_no} and r.cardset_no = c.no and c.member_no = m.no
				order by recordday desc) as r
		group by r.cardset_no, r.method
	</select>
	
	<select id="getLast" parameterType="Map" resultType="rdto">
		select r.*
		from (
				select r.*,c.title, c.comment, m.name, 
						if(
					   		INSTR(profile,'google')>0,
					   		m.profile,
					   		if(
					   			INSTR(m.profile,'kakao')>0,
					   			m.profile,
					   			if(
					   				INSTR(m.profile,m.no)>0,
					   				concat('http://localhost:9000/profile/users/',m.profile),
					   				concat('http://localhost:9000/profile/default/',m.profile)
					   			)
					   		)
					   	) as profile
				from record r,cardset c, member m 
				where r.member_no = #{member_no} and r.cardset_no = #{cardset_no} and r.cardset_no = c.no and c.member_no = m.no
				order by recordday desc) as r
		group by r.cardset_no
	</select>
	
	<select id="getChart" parameterType="Map" resultType="rdto">
		select *
		from record
		where member_no = #{member_no} and cardset_no in (#{cardset_no})
		order by cardset_no asc, method desc, recordday asc
	</select>
</mapper>